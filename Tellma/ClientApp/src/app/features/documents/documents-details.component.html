<t-details *ngIf="found;else pageNotFound" collection="Document" [definition]="definitionId" [createFunc]="create"
    [cloneFunc]="clone" [expand]="expand" [mode]="mode" [additionalSelect]="additionalSelect"
    [masterCrumb]="masterCrumb" [detailsCrumb]="detailsCrumb" [idString]="idString" [documentTemplate]="document"
    [isInactive]="isInactive" [documentHeaderTemplate]="documentHeader" [actions]="[
    ]" [sidebarTemplate]="showSidebar ? sidebar: null" [registerPristineFunc]="registerPristineFunc"
    [isDirtyFunc]="isDirtyFunc" [extraParams]="extraParams" [handleFreshExtras]="handleFreshExtras"
    [toolbarTemplate]="toolbar">

</t-details>

<!-- If definitionId is invalid -->
<ng-template #pageNotFound>
    <t-application-page-not-found>
    </t-application-page-not-found>
</ng-template>

<!-- Details Crumb -->
<ng-template #detailsCrumb let-model="model">
    <span>{{ formatSerial(model?.SerialNumber) }}</span>
</ng-template>

<!-- Extra toolbar buttons -->
<ng-template #toolbar let-model="model" let-extras="extras" let-isEdit="isEdit">
    <!-- Unpost -->
    <div class="d-inline-block" [placement]="actionsDropdownPlacement" [ngbTooltip]="postingStateTooltip(model)"
        container="body" *ngIf="!isEdit && showUnpost(model, extras?.RequiredSignatures)">
        <button class="btn btn-sm btn-light t-white-button text-primary t-toolbar-button" (click)="onUnpost(model)"
            [disabled]="!hasPermissionToUpdateState(model)">
            <fa-icon icon="undo"></fa-icon>
            <span class="d-none d-md-inline">&nbsp;&nbsp;{{ "Unpost" | translate }}</span>
        </button>
    </div>
    <!-- Cancel -->
    <div class="d-inline-block" [placement]="actionsDropdownPlacement" [ngbTooltip]="postingStateTooltip(model)"
        container="body" *ngIf="!isEdit && showCancel(model, extras?.RequiredSignatures)">
        <button class="btn btn-sm btn-danger t-toolbar-button" (click)="onCancel(model)"
            [disabled]="!hasPermissionToUpdateState(model)">
            <fa-icon icon="times"></fa-icon>
            <span class="d-none d-md-inline">&nbsp;&nbsp;{{ "Cancel" | translate }}</span>
        </button>
    </div>
    <!-- Post -->
    <div class="d-inline-block" [placement]="actionsDropdownPlacement" [ngbTooltip]="postingStateTooltip(model)"
        container="body" *ngIf="!isEdit && showPost(model, extras?.RequiredSignatures)">
        <button class="btn btn-sm btn-success t-toolbar-button" (click)="onPost(model)"
            [disabled]="!hasPermissionToUpdateState(model)">
            <fa-icon icon="check"></fa-icon>
            <span class="d-none d-md-inline">&nbsp;&nbsp;{{ "Post" | translate }}</span>
        </button>
    </div>
    <!-- Uncancel -->
    <div class="d-inline-block" [placement]="actionsDropdownPlacement" [ngbTooltip]="postingStateTooltip(model)"
        container="body" *ngIf="!isEdit && showUncancel(model, extras?.RequiredSignatures)">
        <button class="btn btn-sm btn-light t-white-button text-primary t-toolbar-button"
            (click)="!isEdit && onUncancel(model)" [disabled]="!hasPermissionToUpdateState(model)">
            <fa-icon icon="undo"></fa-icon>
            <span class="d-none d-md-inline">&nbsp;&nbsp;{{ "Uncancel" | translate }}</span>
        </button>
    </div>
</ng-template>

<ng-template #documentHeader let-model="model" let-extras="extras" let-isEdit="isEdit">
    <div class="w-100 t-document-header d-flex justify-content-end">
        <!-- Positive state in wide screen -->
        <div>
            <div class="t-flow-chart small d-none d-lg-block" *ngIf="!showLoneState(model)">
                <div [class.active]="isState(0, model)">
                    <span>{{'Document_State_0' | translate}}</span></div>
                <div [class.active]="isState(1, model)" *ngIf="showState(model, extras?.RequiredSignatures, 1)">
                    <span>{{'Document_State_1' | translate}}</span></div>
                <div [class.active]="isState(2, model)" *ngIf="showState(model, extras?.RequiredSignatures, 2)">
                    <span>{{'Document_State_2' | translate}}</span></div>
                <div [class.active]="isState(3, model)" *ngIf="showState(model, extras?.RequiredSignatures, 3)">
                    <span>{{'Document_State_3' | translate}}</span></div>
                <div [class.active]="isState(4, model)" *ngIf="showState(model, extras?.RequiredSignatures, 4)">
                    <span>{{'Document_State_4' | translate}}</span></div>
                <div [class.active]="model?.PostingState === 1">
                    <span>{{'Document_PostingState_1' | translate}}</span></div>
            </div>
            <div class="small t-lone-state active d-none d-lg-block" *ngIf="showLoneState(model)">
                <!-- Negative state in wide screen-->
                <ng-container *ngTemplateOutlet="loneState">

                </ng-container>
            </div>
            <div class="small t-lone-state active d-block d-lg-none">
                <!-- Narrow screen -->
                <ng-container *ngTemplateOutlet="loneState"> </ng-container>
            </div>
        </div>

        <ng-template #loneState>
            <span>{{ (model?.PostingState === 1 ? 'Document_PostingState_1' :
                            model?.PostingState === -1 ? 'Document_PostingState_minus_1' :
                            !model?.State ? 'Document_State_0' :
                            model?.State === -1 ? 'Document_State_minus_1' :
                            model?.State === 1 ? 'Document_State_1' :
                            model?.State === -2 ? 'Document_State_minus_2' :
                            model?.State === 2 ? 'Document_State_2' :
                            model?.State === -3 ? 'Document_State_minus_3' :
                            model?.State === 3 ? 'Document_State_3' :
                            model?.State === -4 ? 'Document_State_minus_4' :
                            model?.State === 4 ? 'Document_State_4' :
                             model?.State) | translate }}</span>
        </ng-template>
    </div>
</ng-template>


<!-- Edit/View Template -->
<ng-template #document let-model="model" let-extras="extras" let-isEdit="isEdit">

    <!-- Serial Number -->
    <t-form-group class="col-12 mb-2 mb-sm-4 t-h2">
        <h2 class="font-weight-normal" *ngIf="!isEdit || isOriginalDocument">{{ formatSerial(model?.SerialNumber) }}
        </h2>
        <t-serial-editor *ngIf="isEdit && !isOriginalDocument" [(ngModel)]="model.SerialNumber"
            [ngModelOptions]="{ updateOn: 'blur' }" [codeWidth]="codeWidth" [prefix]="serialPrefix" required>
        </t-serial-editor>

    </t-form-group>

    <!-- Document Date -->
    <t-form-group class="t-form-group" [label]="'Document_DocumentDate' | translate"
        [serverErrors]="model?.serverErrors?.DocumentDate">
        <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.DocumentDate">
            <div>{{ model?.DocumentDate | date:'yyyy-MM-dd' }}</div>
        </t-restricted>
        <t-date-picker *ngIf="isEdit" [(ngModel)]="model.DocumentDate" [ngModelOptions]="{ updateOn: 'blur' }"
            [required]="true">
        </t-date-picker>
    </t-form-group>

    <!-- TODO: Remove -->
    <!-- <t-form-group-cell class="t-form-group" [label]="'Document_Agent' | translate">
        <t-agents-picker [required]="isEdit" [definitionIds]="['customers']" [(ngModel)]="model.AgentId">
        </t-agents-picker>
    </t-form-group-cell> -->

    <!-- Clearance -->
    <t-form-group class="t-form-group" [label]="'Document_Clearance' | translate"
        [serverErrors]="model?.serverErrors?.Clearance" *ngIf="showClearance(model)">
        <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.Clearance">
            <div>{{ clearanceDisplay(model?.Clearance) }}</div>
        </t-restricted>
        <t-selector *ngIf="isEdit" [(ngModel)]="model.Clearance" [choices]="clearanceChoices">
        </t-selector>
    </t-form-group>

    <!-- Agent -->
    <!-- <t-form-group class="t-form-group" [label]="labelDocumentAgent(model)" [serverErrors]="model?.serverErrors?.AgentId"
        *ngIf="showDocumentAgent(model)">
        <t-restricted *ngIf="!isEdit" [metadata]="model?.EntityMetadata?.AgentId">
            <t-view-link [link]="'../../../agents/' + ws.get('Agent', model?.AgentId)?.DefinitionId"
                [itemId]="model?.AgentId">
                {{ ws.getMultilingualValue('Agent', model?.AgentId, 'Name') }}
            </t-view-link>
        </t-restricted>
        <t-agents-picker *ngIf="isEdit" [(ngModel)]="model.AgentId" [definitionIds]="documentAgentDefinitionIds(model)"
            [required]="requireDocumentAgent(model)">
        </t-agents-picker>
    </t-form-group> -->

    <!-- Memo -->
    <t-form-group *ngIf="model?.MemoIsCommon && definitionId === 'manual-journal-vouchers'" class="t-form-group"
        [label]="'Memo' | translate" [serverErrors]="model?.serverErrors?.Memo">
        <div *ngIf="!isEdit">{{ model?.Memo }}</div>
        <t-text-editor *ngIf="isEdit" [(ngModel)]="model.Memo" [ngModelOptions]="{ updateOn: 'blur' }"></t-text-editor>
    </t-form-group>

    <!-- Memo Is Common -->
    <t-form-group *ngIf="isEdit && definitionId === 'manual-journal-vouchers'" class="t-form-group"
        [label]="'Document_MemoIsCommon' | translate" [serverErrors]="model?.serverErrors?.MemoIsCommon">
        <div class="custom-control custom-checkbox t-labelless-checkbox">
            <input type="checkbox" class="custom-control-input" [(ngModel)]="model.MemoIsCommon" id="memoIsCommon">
            <label class="custom-control-label t-pointer" for="memoIsCommon">&zwnj;</label>
        </div>
    </t-form-group>

    <ul ngbNav #tabs="ngbNav" class="pt-3 pt-sm-4 w-100 nav-tabs" [destroyOnHide]="true"
        [activeId]="getActiveTab(model)" (activeIdChange)="onTabChange($event, isEdit)">
        <li *ngFor="let lineDefId of visibleTabs(model)" [ngbNavItem]="lineDefId">
            <a ngbNavLink>
                <span
                    class="small t-slightly-bold">{{ tabTitle(lineDefId, model) + (!model.Id || model?.EntityMetadata?.Lines === 2 ? ' (' + (lines(lineDefId, model).length | number) + ')' : '') }}</span>
                <span *ngIf="showLineErrors(lineDefId, model)" class="text-danger">&nbsp;<fa-icon
                        icon="exclamation-triangle">
                    </fa-icon>
                </span>
            </a>
            <ng-template ngbNavContent>
                <t-restricted [metadata]="model?.EntityMetadata?.Lines"
                    [class.p-4]="model?.EntityMetadata?.Lines === 1">

                    <!-- Smart Lines -->
                    <ng-container *ngIf="lineDefId !== 'ManualLine'">

                        <!-- Table -->
                        <t-table *ngIf="!showAsForm(lineDefId, model)" [dataSource]="lines(lineDefId, model)"
                            [isEdit]="isEdit" [columnPaths]="columnPaths(lineDefId, model)"
                            [columnTemplates]="columnTemplates(lineDefId, model, smartHeader, smartRow)"
                            [onNewItem]="onNewLineFactory(lineDefId)" (insert)="onInsert($event, model)"
                            (delete)="onDelete($event, model)">
                        </t-table>

                        <!-- Form -->
                        <ng-container *ngIf="showAsForm(lineDefId, model)">
                            <div class="row m-0 mt-2">
                                <ng-container *ngIf="lines(lineDefId, model).length > 0; else noFormMessage">
                                    <ng-container *ngFor="let colPath of columnPaths(lineDefId, model)">
                                        <ng-container *ngTemplateOutlet="smartRow; context: { 
                                                item: lines(lineDefId, model)[0], 
                                                argument: colPath, 
                                                index: 0, 
                                                update: dummyUpdate, 
                                                isForm: true }">
                                        </ng-container>
                                    </ng-container>
                                </ng-container>
                                <ng-template #noFormMessage>
                                    <div class="px-3 text-muted font-italic">
                                        {{ 'NotAdded' | translate }}
                                    </div>
                                </ng-template>
                            </div>

                            <div class="col-12 py-1 px-3 mt-3 d-flex" *ngIf="isEdit">
                                <!-- Add button -->
                                <button *ngIf="lines(lineDefId, model).length === 0" class="btn btn-sm btn-primary"
                                    (click)="onCreateForm(lineDefId, model)">
                                    <fa-icon icon="plus"></fa-icon>&nbsp;&nbsp;{{ 'Add' | translate }}
                                </button>
                                <!-- Actions dropdown -->
                                <div *ngIf="lines(lineDefId, model).length === 1" class="btn-group" ngbDropdown
                                    [placement]="actionsDropdownPlacement">
                                    <button type="button" class="btn btn-sm btn-primary dropdown-toggle"
                                        ngbDropdownToggle>
                                        {{ 'Actions' | translate }}
                                    </button>
                                    <div class="dropdown-menu shadow small" ngbDropdownMenu aria-labelledby="action">
                                        <button ngbDropdownItem class="dropdown-item t-transparent-background"
                                            (click)="onDeleteForm(lineDefId, model)">
                                            {{ ('Delete' | translate) + ' ' + tabTitle(lineDefId, model) }}
                                        </button>
                                        <button ngbDropdownItem class="dropdown-item t-transparent-background"
                                            (click)="onCreateForm(lineDefId, model)">
                                            {{ 'AddAnotherSwitchToTable' | translate }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </ng-container>
                    </ng-container>

                    <!-- Manual Lines -->
                    <t-table *ngIf="lineDefId === 'ManualLine'" [dataSource]="lines(lineDefId, model)" [isEdit]="isEdit"
                        [itemSize]="80" [columnPaths]="columnPaths(lineDefId, model)" [columnTemplates]="{
                        'Memo' : { headerTemplate : header_Memo, rowTemplate : row_Memo, weight : 2 },
                        'AccountId' : { headerTemplate : header_AccountId, rowTemplate : row_AccountId, weight : 3 },
                        'Debit' : { headerTemplate : header_Debit, rowTemplate : row_Debit, weight : 1 },
                        'Credit' : { headerTemplate : header_Credit, rowTemplate : row_Credit, weight : 1 },
                        'ResponsibilityCenter' : { headerTemplate : header_ResponsibilityCenter, rowTemplate : row_ResponsibilityCenter, weight : 1 }
                    }" [onNewItem]="onNewLineFactory(lineDefId)" (insert)="onInsert($event, model)"
                        (delete)="onDelete($event, model)">
                    </t-table>
                </t-restricted>

                <!-- Smart Line -->
                <ng-template #smartHeader let-columnIndex="argument">
                    <div [style.text-align]="columnLabelAlignment(lineDefId, columnIndex)"
                        [style.min-width.px]="isEdit ? 120 : 0">
                        <!-- 32 + 19 + [7 x (9.6 + X)] < 961 -->
                        {{ columnLabel(lineDefId, columnIndex) }}&nbsp;&nbsp;</div>
                </ng-template>
                <ng-template #smartRow let-line="item" let-columnIndex="argument" let-rowIndex="index"
                    let-update="update" let-isForm="isForm">

                    <t-form-group-cell *ngIf="!isForm" class="t-form-group"
                        [serverErrors]="serverErrors(lineDefId, columnIndex, line)">
                        <ng-container *ngTemplateOutlet="formGroupContents"> </ng-container>
                    </t-form-group-cell>
                    <t-form-group *ngIf="isForm" class="t-form-group"
                        [serverErrors]="serverErrors(lineDefId, columnIndex, line)"
                        [label]="columnLabel(lineDefId, columnIndex)">
                        <ng-container *ngTemplateOutlet="formGroupContents"> </ng-container>
                    </t-form-group>

                    <ng-template #formGroupContents>
                        <!-- <t-restricted *ngIf="!isEdit" [metadata]="entityMetadata(lineDefId, columnIndex, line)"
                            [ngSwitch]="columnName(lineDefId, columnIndex)"> -->
                        <ng-container *ngIf="!isEdit" [ngSwitch]="columnName(lineDefId, columnIndex)">
                            <t-view-link *ngSwitchCase="'AccountId'" link="../../../accounts"
                                [itemId]="getFieldValue(lineDefId, columnIndex, line)">
                                {{
                                        ws.getMultilingualValue('Account', getFieldValue(lineDefId, columnIndex, line), 'Name') }}
                            </t-view-link>
                            <t-view-link *ngSwitchCase="'CurrencyId'" link="../../../currencies"
                                [itemId]="getFieldValue(lineDefId, columnIndex, line)">
                                {{
                                        ws.getMultilingualValue('Currency', getFieldValue(lineDefId, columnIndex, line), 'Name') }}
                            </t-view-link>
                            <t-view-link *ngSwitchCase="'AgentId'"
                                [link]="'../../../agents/' + ws.get('Agent', getFieldValue(lineDefId, columnIndex, line))?.DefinitionId"
                                [itemId]="getFieldValue(lineDefId, columnIndex, line)">
                                {{ ws.getMultilingualValue('Agent', getFieldValue(lineDefId, columnIndex, line), 'Name') }}
                            </t-view-link>
                            <t-view-link *ngSwitchCase="'ResourceId'"
                                [link]="'../../../resources/' + ws.get('Resource', getFieldValue(lineDefId, columnIndex, line))?.DefinitionId"
                                [itemId]="getFieldValue(lineDefId, columnIndex, line)">
                                {{ ws.getMultilingualValue('Resource', getFieldValue(lineDefId, columnIndex, line), 'Name') }}
                            </t-view-link>
                            <t-view-link *ngSwitchCase="'ResponsibilityCenterId'" link="../../../responsibility-centers"
                                [itemId]="getFieldValue(lineDefId, columnIndex, line)">
                                {{ ws.getMultilingualValue('ResponsibilityCenter', getFieldValue(lineDefId, columnIndex, line), 'Name') }}
                            </t-view-link>
                            <t-view-link *ngSwitchCase="'EntryTypeId'" link="../../../entry-types"
                                [itemId]="getFieldValue(lineDefId, columnIndex, line)">
                                {{ ws.getMultilingualValue('EntryType', getFieldValue(lineDefId, columnIndex, line), 'Name') }}
                            </t-view-link>
                            <span
                                *ngSwitchCase="'DueDate'">{{ getFieldValue(lineDefId, columnIndex, line) | date:'yyyy-MM-dd'  }}</span>
                            <div *ngSwitchCase="'MonetaryValue'" style="float:right">
                                {{ getFieldValue(lineDefId, columnIndex, line) | number:MonetaryValue_format(entry(lineDefId, columnIndex, line))  }}
                            </div>
                            <div *ngSwitchCase="'Quantity'" style="float:right">
                                {{ getFieldValue(lineDefId, columnIndex, line) | number:'1.0-4'  }}
                            </div>
                            <span
                                *ngSwitchCase="'UnitId'">{{ ws.getMultilingualValue('MeasurementUnit', getFieldValue(lineDefId, columnIndex, line), 'Name')  }}</span>
                            <div *ngSwitchCase="'Value'" style="float:right">
                                {{ getFieldValue(lineDefId, columnIndex, line) | number:functional_format  }}
                            </div>
                            <span
                                *ngSwitchCase="'Time1'">{{ getFieldValue(lineDefId, columnIndex, line) | date:'yyyy-MM-dd'  }}</span>
                            <span
                                *ngSwitchCase="'Time2'">{{ getFieldValue(lineDefId, columnIndex, line) | date:'yyyy-MM-dd'  }}</span>
                            <span
                                *ngSwitchCase="'ExternalReference'">{{ getFieldValue(lineDefId, columnIndex, line) }}</span>
                            <span
                                *ngSwitchCase="'AdditionalReference'">{{ getFieldValue(lineDefId, columnIndex, line) }}</span>
                            <t-view-link *ngSwitchCase="'NotedAgentId'"
                                [link]="'../../../agents/' + ws.get('Agent', getFieldValue(lineDefId, columnIndex, line))?.DefinitionId"
                                [itemId]="getFieldValue(lineDefId, columnIndex, line)">
                                {{ ws.getMultilingualValue('Agent', getFieldValue(lineDefId, columnIndex, line), 'Name') }}
                            </t-view-link>
                            <span
                                *ngSwitchCase="'NotedAgentName'">{{ getFieldValue(lineDefId, columnIndex, line) }}</span>
                            <div *ngSwitchCase="'NotedAmount'" style="float:right">
                                {{ getFieldValue(lineDefId, columnIndex, line) | number:MonetaryValue_format(entry(lineDefId, columnIndex, line))  }}
                            </div>
                            <span
                                *ngSwitchCase="'NotedDate'">{{ getFieldValue(lineDefId, columnIndex, line) | date:'yyyy-MM-dd'  }}</span>
                            <span *ngSwitchCase="'Memo'">{{ getFieldValue(lineDefId, columnIndex, line) }}</span>
                            <span *ngSwitchDefault>{{ getFieldValue(lineDefId, columnIndex, line) }}</span>
                        </ng-container>
                        <ng-container *ngIf="isEdit" [ngSwitch]="columnName(lineDefId, columnIndex)">
                            <t-accounts-picker *ngSwitchCase="'AccountId'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);">
                            </t-accounts-picker>
                            <t-currencies-picker *ngSwitchCase="'CurrencyId'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);">
                            </t-currencies-picker>
                            <t-agents-picker *ngSwitchCase="'AgentId'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [definitionIds]="agentDefinitionIds(lineDefId, columnIndex)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);">
                            </t-agents-picker>
                            <t-resources-picker *ngSwitchCase="'ResourceId'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [filter]="resourcesFilter(lineDefId, columnIndex)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);">
                            </t-resources-picker>
                            <t-responsibility-centers-picker *ngSwitchCase="'ResponsibilityCenterId'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);">
                            </t-responsibility-centers-picker>
                            <t-entry-types-picker *ngSwitchCase="'EntryTypeId'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [filter]="entryTypeFilter(lineDefId, columnIndex)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);">
                            </t-entry-types-picker>
                            <t-date-picker *ngSwitchCase="'DueDate'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);"
                                [ngModelOptions]="{ updateOn: 'blur' }">
                            </t-date-picker>
                            <t-decimal-editor *ngSwitchCase="'MonetaryValue'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);"
                                [ngModelOptions]="{ updateOn: 'blur' }"
                                [minDecimalPlaces]="MonetaryValue_decimals(entry(lineDefId, columnIndex, line))"
                                [maxDecimalPlaces]="MonetaryValue_decimals(entry(lineDefId, columnIndex, line))"
                                [textAlignment]="isForm ? null : 'right'">
                            </t-decimal-editor>
                            <t-decimal-editor *ngSwitchCase="'Quantity'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);"
                                [ngModelOptions]="{ updateOn: 'blur' }" [minDecimalPlaces]="0" [maxDecimalPlaces]="4"
                                [textAlignment]="isForm ? null : 'right'">
                            </t-decimal-editor>
                            <t-measurement-units-picker *ngSwitchCase="'UnitId'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);">
                            </t-measurement-units-picker>
                            <t-decimal-editor *ngSwitchCase="'Value'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);"
                                [ngModelOptions]="{ updateOn: 'blur' }" [minDecimalPlaces]="functional_decimals"
                                [maxDecimalPlaces]="functional_decimals" [textAlignment]="isForm ? null : 'right'">
                            </t-decimal-editor>
                            <t-date-picker *ngSwitchCase="'Time1'" [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);"
                                [ngModelOptions]="{ updateOn: 'blur' }">
                            </t-date-picker>
                            <t-date-picker *ngSwitchCase="'Time2'" [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);"
                                [ngModelOptions]="{ updateOn: 'blur' }">
                            </t-date-picker>
                            <t-text-editor *ngSwitchCase="'ExternalReference'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);"
                                [ngModelOptions]="{ updateOn: 'blur' }">
                            </t-text-editor>
                            <t-text-editor *ngSwitchCase="'AdditionalReference'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);"
                                [ngModelOptions]="{ updateOn: 'blur' }">
                            </t-text-editor>
                            <t-agents-picker *ngSwitchCase="'NotedAgentId'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);">
                            </t-agents-picker>
                            <t-text-editor *ngSwitchCase="'NotedAgentName'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);"
                                [ngModelOptions]="{ updateOn: 'blur' }">
                            </t-text-editor>
                            <t-decimal-editor *ngSwitchCase="'NotedAmount'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);"
                                [ngModelOptions]="{ updateOn: 'blur' }"
                                [minDecimalPlaces]="MonetaryValue_decimals(entry(lineDefId, columnIndex, line))"
                                [maxDecimalPlaces]="MonetaryValue_decimals(entry(lineDefId, columnIndex, line))"
                                [textAlignment]="isForm ? null : 'right'">
                            </t-decimal-editor>
                            <t-date-picker *ngSwitchCase="'NotedDate'"
                                [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);"
                                [ngModelOptions]="{ updateOn: 'blur' }">
                            </t-date-picker>
                            <t-text-editor *ngSwitchCase="'Memo'" [disabled]="isReadOnly(lineDefId, columnIndex, line)"
                                [required]="!line.PH && isRequired(lineDefId, columnIndex, line)"
                                [ngModel]="getFieldValue(lineDefId, columnIndex, line)"
                                (ngModelChange)="setFieldValue(lineDefId, columnIndex, line, $event); update.call(null, line);"
                                [ngModelOptions]="{ updateOn: 'blur' }">
                            </t-text-editor>
                        </ng-container>
                    </ng-template>
                </ng-template>

                <!-- Manual Line -->
                <!-- Memo -->
                <ng-template #header_Memo>{{ 'Memo' | translate }}</ng-template>
                <ng-template #row_Memo let-item="item" let-index="index" let-update="update">
                    <t-form-group-dynamic class="t-form-group" [serverErrors]="item.serverErrors?.Memo">
                        <div *ngIf="!isEdit">
                            <t-restricted [metadata]="item.EntityMetadata?.Memo">{{ item.Memo }}</t-restricted>
                        </div>
                        <t-text-editor *ngIf="isEdit" [(ngModel)]="item.Memo" (ngModelChange)="update.call(null, item)"
                            [ngModelOptions]="{ updateOn: 'blur' }"></t-text-editor>
                    </t-form-group-dynamic>
                </ng-template>

                <!-- AccountId -->
                <ng-template #header_AccountId>{{ 'Entry_Account' | translate }}</ng-template>
                <ng-template #row_AccountId let-item="item" let-entry="item.Entries[0]" let-index="index"
                    let-update="update">
                    <div>
                        <t-form-group-dynamic class="t-form-group" [serverErrors]="entry.serverErrors?.AccountId">
                            <!-- <span *ngIf="isCredit(entry)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> -->
                            <t-restricted [metadata]="entry.EntityMetadata?.AccountId">
                                <t-view-link *ngIf="!isEdit" link="../../../accounts" [itemId]="entry?.AccountId">{{
                      ws.getMultilingualValue('Account',
                      entry.AccountId, 'Name') }}</t-view-link>
                            </t-restricted>
                            <t-accounts-picker *ngIf="isEdit" style="min-width: 150px;" [(ngModel)]="entry.AccountId"
                                (ngModelChange)="update.call(null, item)"
                                additionalSelect="HasExternalReference,HasAdditionalReference,HasNotedAgentId,HasNotedAgentName,ResponsibilityCenter/Name,ResponsibilityCenter/Name2,ResponsibilityCenter/Name3,HasNotedAmount,HasNotedDate,HasResource,AccountType/EntryTypeParentId,AccountType/IsResourceClassification,EntryType/Name,EntryType/Name2,EntryType/Name3,AgentDefinitionId,Currency/Name,Currency/Name2,Currency/Name3,Currency/E,Agent/Name,Agent/Name2,Agent/Name3,Agent/DefinitionId,Resource/Name,Resource/Name2,Resource/Name3,Resource/DefinitionId,Resource/Units/Unit/Name,Resource/Units/Unit/Name2,Resource/Units/Unit/Name3,Resource/Units/Multiplier">
                            </t-accounts-picker>
                        </t-form-group-dynamic>
                    </div>

                    <div class="small d-flex flex-wrap p-2">

                        <!-- Currency -->
                        <ng-container *ngIf="showCurrency(entry)">
                            <t-form-group-dynamic [label]="'Entry_Currency' | translate"
                                [serverErrors]="entry.serverErrors?.CurrencyId">
                                <!-- View -->
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.CurrencyId">
                                    <t-view-link link="../../../currencies" [itemId]="entry.CurrencyId">
                                        {{ ws.getMultilingualValue('Currency', entry.CurrencyId, 'Name') }}
                                    </t-view-link>
                                </t-restricted>
                                <!-- Edit -->
                                <t-currencies-picker *ngIf="isEdit" [(ngModel)]="entry.CurrencyId"
                                    (ngModelChange)="update.call(null, item);" required>
                                </t-currencies-picker>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                        <!-- Monetary Value -->
                        <ng-container *ngIf="showMonetaryValue(entry)">
                            <t-form-group-dynamic [label]="'Entry_MonetaryValue' | translate"
                                [serverErrors]="entry.serverErrors?.MonetaryValue">
                                <!-- View -->
                                <ng-container *ngIf="!isEdit">
                                    <t-restricted [metadata]="entry.EntityMetadata?.MonetaryValue">
                                        {{ entry.MonetaryValue | number:MonetaryValue_format(entry) }}
                                    </t-restricted>
                                </ng-container>
                                <!-- Edit -->
                                <ng-container *ngIf="isEdit">
                                    <t-decimal-editor [(ngModel)]="entry.MonetaryValue"
                                        [maxDecimalPlaces]="MonetaryValue_decimals(entry)"
                                        [minDecimalPlaces]="MonetaryValue_decimals(entry)"
                                        (ngModelChange)="update.call(null, item);"
                                        [ngModelOptions]="{ updateOn: 'blur' }" textAlignment="right" required>
                                    </t-decimal-editor>
                                </ng-container>
                                <!-- Readonly Currency -->
                                <ng-container *ngIf="!showCurrency(entry)">
                                    &nbsp;
                                    <t-restricted [metadata]="entry.EntityMetadata?.CurrencyId">
                                        {{ ws.getMultilingualValue('Currency', isEdit ? readonlyValueCurrencyId(entry) : entry.CurrencyId, 'Name') }}
                                    </t-restricted>

                                </ng-container>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                        <!-- Agent -->
                        <ng-container *ngIf="showAgent(entry)">
                            <t-form-group-dynamic [label]="labelAgent(entry)"
                                [serverErrors]="entry.serverErrors?.AgentId">
                                <!-- View -->
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.AgentId">
                                    <t-view-link
                                        [link]="'../../../agents/' + ws.get('Agent', entry.AgentId)?.DefinitionId"
                                        [itemId]="entry.AgentId">
                                        {{ ws.getMultilingualValue('Agent', entry.AgentId, 'Name') }}
                                    </t-view-link>
                                </t-restricted>
                                <!-- Edit -->
                                <ng-container *ngIf="isEdit">
                                    <t-agents-picker *ngIf="!readonlyAgent(entry)" [(ngModel)]="entry.AgentId"
                                        (ngModelChange)="update.call(null, item);"
                                        [definitionIds]="[account(entry)?.AgentDefinitionId]" required>
                                    </t-agents-picker>
                                    <t-restricted *ngIf="readonlyAgent(entry)"
                                        [metadata]="entry.EntityMetadata?.AgentId">
                                        {{ ws.getMultilingualValue('Agent', readonlyValueAgentId(entry), 'Name') }}
                                    </t-restricted>
                                </ng-container>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                        <!-- Resource -->
                        <ng-container *ngIf="showResource(entry)">
                            <t-form-group-dynamic [label]="labelResource(entry)"
                                [serverErrors]="entry.serverErrors?.ResourceId">
                                <!-- View -->
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.ResourceId">
                                    <t-view-link
                                        [link]="'../../../resources/' + ws.get('Resource', entry.ResourceId)?.DefinitionId"
                                        [itemId]="entry.ResourceId">
                                        {{ ws.getMultilingualValue('Resource', entry.ResourceId, 'Name') }}
                                    </t-view-link>
                                </t-restricted>
                                <!-- Edit -->
                                <ng-container *ngIf="isEdit">
                                    <t-resources-picker *ngIf="!readonlyResource(entry)" [(ngModel)]="entry.ResourceId"
                                        (ngModelChange)="update.call(null, item);"
                                        additionalSelect="Units/Unit/Name,Units/Unit/Name2,Units/Unit/Name3,Units/Multiplier"
                                        [filter]="filterResource(entry)" required>
                                    </t-resources-picker>
                                    <t-restricted *ngIf="readonlyResource(entry)"
                                        [metadata]="entry.EntityMetadata?.ResourceId">
                                        {{ ws.getMultilingualValue('Resource', readonlyValueResourceId(entry), 'Name') }}
                                    </t-restricted>
                                </ng-container>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                        <!-- Quantity + UnitId -->
                        <ng-container *ngIf="showQuantityAndUnit(entry)">
                            <t-form-group-dynamic [label]="'Entry_Quantity' | translate"
                                [serverErrors]="entry.serverErrors?.Quantity">
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.Quantity">
                                    <span>{{ entry.Quantity | number:'1.0-4'}}</span>
                                </t-restricted>
                                <t-decimal-editor *ngIf="isEdit" [(ngModel)]="entry.Quantity" [maxDecimalPlaces]="4"
                                    [minDecimalPlaces]="0" (ngModelChange)="update.call(null, item);"
                                    [ngModelOptions]="{ updateOn: 'blur' }" required>
                                </t-decimal-editor>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                            <t-form-group-dynamic [label]="'Entry_Unit' | translate"
                                [serverErrors]="entry.serverErrors?.UnitId">
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.UnitId">
                                    <!-- <t-view-link link="../../../measurement-units" [itemId]="entry.UnitId"> -->
                                    {{ ws.getMultilingualValue('MeasurementUnit', entry.UnitId, 'Name') }}
                                    <!-- </t-view-link> -->
                                </t-restricted>
                                <ng-container *ngIf="isEdit">
                                    <t-restricted *ngIf="readonlyUnit(entry)" [metadata]="entry.EntityMetadata?.UnitId">
                                        {{ ws.getMultilingualValue('MeasurementUnit', readonlyValueUnitId(entry), 'Name') }}
                                    </t-restricted>
                                    <t-measurement-units-picker *ngIf="!readonlyUnit(entry)" [(ngModel)]="entry.UnitId"
                                        (ngModelChange)="update.call(null, item);" [filter]="filterUnitId(entry)">
                                    </t-measurement-units-picker>
                                </ng-container>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                        <!-- DueDate -->
                        <ng-container *ngIf="showDueDate(entry)">
                            <t-form-group-dynamic [label]="labelDueDate(entry)"
                                [serverErrors]="entry.serverErrors?.DueDate">
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.DueDate">
                                    {{ entry.DueDate | date:'yyyy-MM-dd'}}
                                </t-restricted>
                                <t-date-picker *ngIf="isEdit" [(ngModel)]="entry.DueDate"
                                    (ngModelChange)="update.call(null, item);" [ngModelOptions]="{ updateOn: 'blur' }"
                                    [required]="requireDueDate(entry)">
                                </t-date-picker>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                        <!-- Entry Type -->
                        <ng-container *ngIf="showEntryType(entry)">
                            <t-form-group-dynamic [label]="'Entry_EntryType' | translate"
                                [serverErrors]="entry.serverErrors?.EntryTypeId">
                                <!-- View -->
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.EntryTypeId">
                                    <t-view-link link="../../../entry-types" [itemId]="entry.EntryTypeId">
                                        <div class="text-truncate">
                                            {{ ws.getMultilingualValue('EntryType', entry.EntryTypeId, 'Name') }}
                                        </div>
                                    </t-view-link>
                                </t-restricted>
                                <!-- Edit -->
                                <ng-container *ngIf="isEdit">
                                    <t-entry-types-picker *ngIf="!readonlyEntryType(entry)"
                                        [(ngModel)]="entry.EntryTypeId" (ngModelChange)="update.call(null, item);"
                                        [filter]="filterEntryType(entry)" required>
                                    </t-entry-types-picker>
                                    <t-restricted *ngIf="readonlyEntryType(entry)"
                                        [metadata]="entry.EntityMetadata?.EntryTypeId">
                                        <div class="text-truncate">
                                            {{ ws.getMultilingualValue('EntryType', readonlyValueEntryTypeId(entry), 'Name') }}
                                        </div>
                                    </t-restricted>
                                </ng-container>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                        <!-- External Reference -->
                        <ng-container *ngIf="showExternalReference(entry)">
                            <t-form-group-dynamic [label]="'Entry_ExternalReference' | translate"
                                [serverErrors]="entry.serverErrors?.ExternalReference">
                                <!-- View -->
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.ExternalReference">
                                    <div class="text-truncate">
                                        {{ entry.ExternalReference }}
                                    </div>
                                </t-restricted>
                                <!-- Edit -->
                                <t-text-editor *ngIf="isEdit" [(ngModel)]="entry.ExternalReference"
                                    (ngModelChange)="update.call(null, item);">
                                </t-text-editor>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                        <!-- Additional Reference -->
                        <ng-container *ngIf="showAdditionalReference(entry)">
                            <t-form-group-dynamic [label]="'Entry_AdditionalReference' | translate"
                                [serverErrors]="entry.serverErrors?.AdditionalReference">
                                <!-- View -->
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.AdditionalReference">
                                    <div class="text-truncate">
                                        {{ entry.AdditionalReference }}
                                    </div>
                                </t-restricted>
                                <!-- Edit -->
                                <t-text-editor *ngIf="isEdit" [(ngModel)]="entry.AdditionalReference"
                                    (ngModelChange)="update.call(null, item);">
                                </t-text-editor>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                        <!-- Noted Agent -->
                        <ng-container *ngIf="showNotedAgent(entry)">
                            <t-form-group-dynamic [label]="'Entry_NotedAgent' | translate"
                                [serverErrors]="entry.serverErrors?.NotedAgent">
                                <!-- View -->
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.NotedAgentId">
                                    <t-view-link
                                        [link]="'../../../agents/' + ws.get('Agent', entry.NotedAgentId)?.DefinitionId"
                                        [itemId]="entry.NotedAgentId">
                                        {{ ws.getMultilingualValue('Agent', entry.NotedAgentId, 'Name') }}
                                    </t-view-link>
                                </t-restricted>
                                <!-- Edit -->
                                <t-agents-picker *ngIf="isEdit" [(ngModel)]="entry.NotedAgentId"
                                    (ngModelChange)="update.call(null, item);">
                                </t-agents-picker>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                        <!-- Noted Agent Name -->
                        <ng-container *ngIf="showNotedAgentName(entry)">
                            <t-form-group-dynamic [label]="'Entry_NotedAgentName' | translate"
                                [serverErrors]="entry.serverErrors?.NotedAgentName">
                                <!-- View -->
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.NotedAgentName">
                                    <div class="text-truncate">
                                        {{ entry.NotedAgentName }}
                                    </div>
                                </t-restricted>
                                <!-- Edit -->
                                <t-text-editor *ngIf="isEdit" [(ngModel)]="entry.NotedAgentName"
                                    (ngModelChange)="update.call(null, item);">
                                </t-text-editor>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                        <!-- Noted Amount -->
                        <ng-container *ngIf="showNotedAmount(entry)">
                            <t-form-group-dynamic [label]="'Entry_NotedAmount' | translate"
                                [serverErrors]="entry.serverErrors?.NotedAmount">
                                <!-- View -->
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.NotedAmount">
                                    <div class="text-truncate">
                                        {{ entry.NotedAmount | number:MonetaryValue_format(entry) }}
                                    </div>
                                </t-restricted>
                                <!-- Edit -->
                                <t-decimal-editor *ngIf="isEdit" [minDecimalPlaces]="MonetaryValue_decimals(entry)"
                                    [maxDecimalPlaces]="MonetaryValue_decimals(entry)" [(ngModel)]="entry.NotedAmount"
                                    (ngModelChange)="update.call(null, item);">
                                </t-decimal-editor>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                        <!-- Noted Date -->
                        <ng-container *ngIf="showNotedDate(entry)">
                            <t-form-group-dynamic [label]="'Entry_NotedDate' | translate"
                                [serverErrors]="entry.serverErrors?.NotedDate">
                                <!-- View -->
                                <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.NotedDate">
                                    <div class="text-truncate">
                                        {{ entry.NotedDate | date:'yyyy-MM-dd' }}
                                    </div>
                                </t-restricted>
                                <!-- Edit -->
                                <t-date-picker *ngIf="isEdit" [(ngModel)]="entry.NotedDate"
                                    (ngModelChange)="update.call(null, item);">
                                </t-date-picker>
                                &nbsp;&nbsp;
                            </t-form-group-dynamic>
                        </ng-container>

                    </div>
                </ng-template>

                <!-- ResponsibilityCenter -->
                <ng-template #header_ResponsibilityCenter>
                    <div>{{ 'Entry_ResponsibilityCenter' | translate }}</div>
                </ng-template>
                <ng-template #row_ResponsibilityCenter let-item="item" let-entry="item.Entries[0]" let-index="index"
                    let-update="update">
                    <t-restricted *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.ResponsibilityCenterId">
                        <t-view-link link="../../../responsibility-centers" [itemId]="entry.ResponsibilityCenterId">
                            {{ ws.getMultilingualValue('ResponsibilityCenter', entry.ResponsibilityCenterId, 'Name') }}
                        </t-view-link>
                    </t-restricted>
                    <ng-container *ngIf="isEdit">
                        <t-form-group-dynamic class="t-form-group"
                            [serverErrors]="entry.serverErrors?.ResponsibilityCenterId">
                            <t-responsibility-centers-picker *ngIf="!account(entry)?.ResponsibilityCenterId"
                                [(ngModel)]="entry.ResponsibilityCenterId" (ngModelChange)="update.call(null, item);"
                                filter="IsLeaf eq true">
                            </t-responsibility-centers-picker>
                            <t-restricted *ngIf="!!account(entry)?.ResponsibilityCenterId"
                                [metadata]="entry.EntityMetadata?.ResponsibilityCenterId">
                                {{ ws.getMultilingualValue('ResponsibilityCenter', account(entry)?.ResponsibilityCenterId, 'Name') }}
                            </t-restricted>
                        </t-form-group-dynamic>
                    </ng-container>
                </ng-template>

                <!-- Debit -->
                <ng-template #header_Debit>
                    <div style="float: right">{{ ('Debit' | translate) + functionalPostfix }}</div>
                </ng-template>
                <ng-template #row_Debit let-item="item" let-entry="item.Entries[0]" let-index="index"
                    let-update="update">
                    <t-restricted class="h-100" *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.Value">
                        <div style="float: right">{{ getDebit(entry) | number:functional_format }}</div>
                    </t-restricted>
                    <t-form-group-dynamic *ngIf="isEdit" class="t-form-group"
                        [serverErrors]="entry.serverErrors?.Value">
                        <t-decimal-editor [ngModel]="getDebit(entry)" [maxDecimalPlaces]="functional_decimals"
                            [minDecimalPlaces]="functional_decimals" textAlignment="right"
                            (ngModelChange)="setDebit(entry, $event); update.call(null, item);"
                            [ngModelOptions]="{ updateOn: 'blur' }">
                        </t-decimal-editor>
                    </t-form-group-dynamic>
                </ng-template>

                <!-- Credit -->
                <ng-template #header_Credit>
                    <div style="float: right">{{ ('Credit' | translate) + functionalPostfix }}</div>
                </ng-template>
                <ng-template #row_Credit let-item="item" let-entry="item.Entries[0]" let-index="index"
                    let-update="update">
                    <t-restricted class="h-100" *ngIf="!isEdit" [metadata]="entry.EntityMetadata?.Value">
                        <div style="float: right">{{ getCredit(entry) | number:functional_format }}</div>
                    </t-restricted>
                    <t-form-group-dynamic *ngIf="isEdit" class="t-form-group"
                        [serverErrors]="entry.serverErrors?.Value">
                        <t-decimal-editor [ngModel]="getCredit(entry)" [maxDecimalPlaces]="functional_decimals"
                            [minDecimalPlaces]="functional_decimals" textAlignment="right"
                            (ngModelChange)="setCredit(entry, $event); update.call(null, item);"
                            [ngModelOptions]="{ updateOn: 'blur' }">
                        </t-decimal-editor>
                    </t-form-group-dynamic>
                </ng-template>

                <div class="row mx-0"
                    *ngIf="!isEdit && requiredSignaturesForLineDef(model, lineDefId, extras)?.length > 0">
                    <div class="col-12 mt-3">
                        <span class="small font-weight-bold">{{ 'Document_Signatures' | translate }}</span>
                    </div>
                    <div class="col-12 col-lg-6 px-2 px-lg-5 mt-3 mb-1"
                        *ngFor="let signature of requiredSignaturesForLineDef(model, lineDefId, extras)">
                        <div class="border-bottom d-flex align-items-stretch p-2 bg-light">

                            <!-- just to keep the height when the parent div is empty-->
                            <div style="height: 37px;"></div>

                            <!-- Signature exists -->
                            <ng-container *ngIf="!!signature.SignedById">
                                <!-- Profile Picture -->
                                <div class="d-flex align-items-center justify-content">
                                    <t-image [src]="'users/' + signature.SignedById + '/image'"
                                        [imageId]="ws.get('User', signature.SignedById)?.ImageId" [size]="36"
                                        shape="circle">
                                    </t-image>
                                </div>
                                <!-- User Name -->
                                <div class="p-2 flex-grow-1 text-truncate d-flex align-items-center">
                                    <span>
                                        <t-view-link link="../../../users" [itemId]="signature.SignedById">
                                            {{ ws.getMultilingualValue('User', signature.SignedById, 'Name') }}
                                        </t-view-link>
                                        <span
                                            *ngIf="!!signature.OnBehalfOfUserId && signature.SignedById !== signature.OnBehalfOfUserId">
                                            {{ 'OnBehalfOf' | translate }}<t-view-link link="../../../users"
                                                [itemId]="signature.OnBehalfOfUserId">
                                                {{ ws.getMultilingualValue('User', signature.OnBehalfOfUserId, 'Name') }}
                                            </t-view-link></span>
                                    </span>
                                </div>
                                <!-- Stamp -->
                                <div class="d-flex align-items-center" [class.text-success]="signature.ToState > 0"
                                    [class.text-danger]="signature.ToState < 0">
                                    <div class="px-1 font-weight-bold t-large"
                                        [class.t-positive-stamp]="signature.ToState > 0"
                                        [class.t-negative-stamp]="signature.ToState < 0">
                                        <span>{{ actionDisplay(signature.ToState) }}</span>
                                    </div>
                                </div>
                                <!-- Reason if any -->
                                <ng-container *ngIf="!!signature.ReasonDetails || !!signature.ReasonId">
                                    &nbsp;&nbsp;
                                    <div class="text-danger small align-items-center" style="max-width: 120px;">
                                        <span
                                            class="font-weight-bold">{{ 'Signature_Reason' | translate }}:&nbsp;</span>
                                        <span>{{ signature.ReasonDetails }}</span>
                                    </div>
                                </ng-container>
                            </ng-container>

                            <!-- No signature but can sign -->
                            <ng-container *ngIf="!signature.SignedById && signature.CanSign">
                                <button class="btn btn-danger px-2 w-50" (click)="onSignNo(lineDefId, signature)">
                                    <fa-icon [icon]="negativeActionIcon(signature.ToState)"></fa-icon>
                                    <span>&nbsp;&nbsp;{{ negativeActionDisplay(signature.ToState) }}</span>
                                </button>&nbsp;&nbsp;
                                <button class="btn btn-success px-2 w-50" (click)="onSignYes(signature)">
                                    <fa-icon [icon]="positiveActionIcon(signature.ToState)"></fa-icon>
                                    <span>&nbsp;&nbsp;{{ positiveActionDisplay(signature.ToState) }}</span>
                                </button>
                            </ng-container>

                            <!-- No signature and cannot sign -->
                            <ng-container *ngIf="!signature.SignedById && !signature.CanSign">

                            </ng-container>
                        </div>

                        <!-- Footer: type of signature and signing time -->
                        <div class="px-2 small p-1 d-flex justify-content-between">
                            <div class="text-truncate">
                                <span>
                                    <!-- Action -->
                                    <span
                                        *ngIf="signature.RuleType !== 'Public'">{{ requiredSignatureDisplay(signature) }}</span>
                                    <span
                                        *ngIf="signature.RuleType === 'Public'">{{ requiredSignatoryDisplay(signature) }}</span>

                                    <!-- Who's signing -->
                                    <t-view-link *ngIf="signature.RuleType === 'ByRole'" link="../../../roles"
                                        [itemId]="signature.RoleId">
                                        {{ ws.getMultilingualValue('Role', signature.RoleId, 'Name') }}
                                    </t-view-link>
                                    <t-view-link
                                        *ngIf="signature.RuleType === 'ByAgent' || signature.RuleType === 'ByUser'"
                                        link="../../../users" [itemId]="signature.UserId">
                                        {{ ws.getMultilingualValue('User', signature.UserId, 'Name') }}
                                    </t-view-link>

                                    <!-- # of lines -->
                                    <span
                                        *ngIf="lineIds(signature).length !== lines(lineDefId, model).length">({{ 'Count0Lines' | translate: { '0': (lineIds(signature).length | number) } }})</span>
                                </span>
                            </div>
                            <div>
                                <span class="text-muted" *ngIf="signature.SignedAt">
                                    &nbsp;{{ signature.SignedAt | date:'yyyy-MM-dd HH:mm' }}
                                </span>
                                <button class="btn btn-sm btn-light text-primary t-white-button btn-sm py-0 px-1"
                                    (click)="onUnsign(signature)" *ngIf="canUnsign(signature)" style="margin-top:-4px"
                                    [title]="'Delete' | translate">
                                    <fa-icon icon="trash"></fa-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </ng-template>
        </li>
        <li ngbDropdown *ngIf="isEdit && invisibleTabs(model).length > 0">
            <a href (click)="false" class="nav-link t-no-arrow" ngbDropdownToggle><span class="small t-slightly-bold">
                    <fa-icon icon="ellipsis-h"></fa-icon>
                </span></a>
            <div ngbDropdownMenu>
                <button class="t-transparent-background" *ngFor="let lineDefId of invisibleTabs(model)" ngbDropdownItem
                    (click)="onOtherTab(lineDefId)">{{ tabTitle(lineDefId, model) }}</button>
            </div>
        </li>

        <li class="{{ attachmentsClass }}" [ngbNavItem]="'Attachment'">
            <a ngbNavLink><span
                    class="small t-slightly-bold">{{ ('Document_Attachments' | translate) + (!model.Id || model?.EntityMetadata?.Attachments === 2 ? ' (' + (model?.Attachments?.length | number) + ')' : '')}}</span>
            </a>
            <ng-template ngbNavContent>
                <!-- No Attachments Message -->
                <div class="p-3 font-italic font-weight-light2 text-muted"
                    *ngIf="!model?.Attachments?.length && !isEdit">
                    <span>{{ 'NoItemsFound' | translate }}</span>
                </div>

                <!-- Attachments List -->
                <div *ngIf="!!model?.Attachments?.length">
                    <div class="p-13 col-122 t-dynamic-container2 text-nowrap"
                        *ngFor="let att of model?.Attachments; let i = index;">
                        <div class="p-2 bg-light border-bottom d-flex" [class.bg-light]="i % 2 === 0">
                            <!-- Icon and Name -->
                            <div class="flex-grow-1 text-truncate">
                                <div class="d-flex t-borderless-input2 align-items-center">
                                    <fa-icon class="px-1 text-muted" style="font-size: 150%;"
                                        [icon]="iconFromExtension(att.FileExtension)">
                                    </fa-icon>
                                    <span>&nbsp;&nbsp;&nbsp;</span>
                                    <span *ngIf="!isEdit">{{ att.FileName }}</span>
                                    <t-form-group class="w-100" [serverErrors]="att?.serverErrors?.FileName">
                                        <t-text-editor [(ngModel)]="att.FileName"
                                            [ngModelOptions]="{ updateOn: 'blur' }" *ngIf="isEdit" [required]="true">
                                        </t-text-editor>
                                    </t-form-group>
                                </div>
                            </div>

                            <!-- Commands -->
                            <div class="d-flex align-items-center">
                                <span class="px-2 small text-muted">{{ size(att) }}</span>
                                <button *ngIf="!att.downloading"
                                    class="btn btn-sm2 text-primary p-0 px-2 t-toolbar-button btn-light t-white-button"
                                    (click)="onDownloadAttachment(model, i)" [title]="'Download' | translate">
                                    <fa-icon icon="download"></fa-icon>
                                </button>
                                <div class="px-2 t-toolbar-button" *ngIf="att.downloading">
                                    <t-spinner class="text-black"></t-spinner>
                                </div>
                                <button
                                    class="btn btn-sm2 text-primary p-0 px-2 t-toolbar-button btn-light t-white-button"
                                    *ngIf="isEdit" (click)="onDeleteAttachment(model, i)"
                                    [title]="'Delete' | translate">
                                    <fa-icon icon="trash"></fa-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Button -->
                <div class="p-2" *ngIf="isEdit">
                    <button class="btn btn-sm text-primary btn-light t-white-button" (click)="fileInput.click()">
                        <fa-icon icon="upload"></fa-icon>&nbsp;&nbsp;{{ 'Upload' | translate }}
                    </button>
                </div>

            </ng-template>
        </li>
    </ul>
    <div class="w-100" [ngbNavOutlet]="tabs">

    </div>

    <!-- for the file dialog -->
    <input type="file" class="d-none" #fileInput (change)="onFileSelected(fileInput, model)" />
</ng-template>

<ng-template #sidebar let-model="model" let-isEdit="isEdit">
    <div class="d-flex justify-content-center p-2">
        <div class="w-100 t-paper-width">
            <!-- <div class="py-3 px-3 d-flex justify-content-center small font-weight-bold" *ngIf="!!model.AssigneeId">
                {{ 'Document_AssignmentsHistory' | translate }}
            </div> -->

            <!-- Currently with -->
            <div class="t-biege border-bottom border-top2 py-2 px-3" *ngIf="!!model.AssigneeId">
                <div class="d-flex">
                    <t-image [src]="'users/' + model.AssigneeId + '/image'"
                        [imageId]="ws.get('User', model.AssigneeId)?.ImageId" [size]="picSize" shape="circle"></t-image>
                    <div class="p-2 text-truncate">
                        <t-view-link link="../../../users" [itemId]="model.AssigneeId">
                            {{ ws.getMultilingualValue('User', model.AssigneeId, 'Name') }}</t-view-link>
                        {{ 'OwnsThisDocument' | translate }}
                    </div>
                </div>

                <!-- Assign the document -->
                <div class="px-2 pb-2 pt-0" [style.margin-left.px]="marginLeft" [style.margin-right.px]="marginRight"
                    *ngIf="showAssignDocument(model)">
                    <div class="form-group">
                        <label class="small font-weight-bold" for="user">{{ 'AssignTo' | translate }}</label>
                        <div class="bg-white border t-borderless-input p-1">
                            <t-users-picker id="user" [(ngModel)]="assigneeId" [filter]="'Id ne ' + model.AssigneeId"
                                [showCreate]="false">
                            </t-users-picker>
                        </div>
                    </div>
                    <div class="form-group">
                        <!-- <label class="small font-weight-bold" for="message">Message (Optional)</label> -->
                        <textarea type="password" class="form-control t-input p-1 border bg-white" id="message"
                            placeholder="{{ 'OptionalMessage' | translate }}" [(ngModel)]="comment"></textarea>
                    </div>
                    <button class="btn btn-primary btn-sm" (click)="onAssign(model)"
                        [disabled]="!canAssign(model, isEdit)">{{ 'Assign' | translate }}</button>
                </div>
            </div>

            <!-- All history -->
            <ng-container *ngFor="let dayEvents of sortChronologically(model)">
                <div class="px-3 py-3 small font-weight-bold">{{ dayEvents.date }}</div>

                <!-- Day's history -->
                <ng-container *ngFor="let event of dayEvents.events; let i = index;">
                    <div class="t-biege border-bottom pt-2 pb-2 px-3" [class.border-top]="i === 0"
                        [ngSwitch]="event.type">

                        <!-- Reassignment -->
                        <ng-container *ngSwitchCase="'reassignment'">
                            <div class="d-flex flex-wrap">
                                <t-image [src]="'users/' + event.userId + '/image'"
                                    [imageId]="ws.get('User', event.userId)?.ImageId" [size]="36" shape="circle">
                                </t-image>
                                <div class="p-2 text-truncate">
                                    <t-view-link link="../../../users" [itemId]="event.userId">
                                        {{ ws.getMultilingualValue('User', event.userId, 'Name') }}
                                    </t-view-link>
                                </div>
                                &nbsp;
                                <div class="pt-2">
                                    <fa-icon icon="angle-right" [flip]="flip" [size]="120"></fa-icon>
                                </div>
                                &nbsp;
                                &nbsp;
                                <t-image [src]="'users/' + reassignment(event).assigneeId + '/image'"
                                    [imageId]="ws.get('User', reassignment(event).assigneeId)?.ImageId" [size]="36"
                                    shape="circle">
                                </t-image>
                                <div class="p-2 text-truncate">
                                    <t-view-link link="../../../users" [itemId]="reassignment(event).assigneeId">
                                        {{ ws.getMultilingualValue('User', reassignment(event).assigneeId, 'Name') }}
                                    </t-view-link>
                                </div>
                                <div class="py-2 text-truncate">
                                    <span class="my-auto t-vertical-alignment-center small text-muted">
                                        {{ event.time | date:'HH:mm' }}
                                    </span>
                                </div>
                            </div>
                            <div class="pt-1 pb-2 px-2" [style.margin-left.px]="marginLeft"
                                [style.margin-right.px]="marginRight" *ngIf="!!reassignment(event).comment">
                                {{ reassignment(event).comment }}
                            </div>
                        </ng-container>

                        <!-- Creation -->
                        <ng-container *ngSwitchCase="'creation'">
                            <div class="d-flex">
                                <t-image [src]="'users/' + event.userId + '/image'"
                                    [imageId]="ws.get('User', event.userId)?.ImageId" [size]="36" shape="circle">
                                </t-image>
                                <div class="p-2 text-truncate">
                                    <t-view-link link="../../../users" [itemId]="event.userId">
                                        {{ ws.getMultilingualValue('User', event.userId, 'Name') }}</t-view-link>
                                    {{ 'CreatedThisDocument' | translate }}
                                </div>
                                <div class="py-2 text-truncate">
                                    <span class="small text-muted">
                                        {{ event.time | date:'HH:mm' }}
                                    </span>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </ng-container>
            </ng-container>
        </div>
    </div>
</ng-template>

<!-- Confirmation Modal -->
<ng-template #confirmModal let-modal>

    <!-- header -->
    <div class="modal-header">
        <h5 class="modal-title"> {{ 'Confirmation' | translate }} </h5>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss(false)">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <!-- body -->
    <div class="modal-body">
        {{ confirmationMessage }}
    </div>

    <!-- footer -->
    <div class="modal-footer">
        <button class="btn btn-danger" (click)="modal.close(true)">
            <fa-icon icon="check"></fa-icon>
            &nbsp;{{ 'Yes' | translate }}
        </button>
        <button class="btn btn-light text-primary t-white-button" (click)="modal.close(false)" ngbAutofocus>
            <fa-icon icon="times"></fa-icon>
            &nbsp;{{ 'No' | translate }}
        </button>
    </div>
</ng-template>

<!-- Negative Signature Modal -->
<ng-template #negativeSignatureModal let-modal>

    <!-- header -->
    <div class="modal-header">
        <h5 class="modal-title"> {{ 'AdditionalInformation' | translate }} </h5>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss(false)">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <!-- body -->
    <div class="modal-body">
        <!-- Reason -->
        <div class="mt-1" *ngIf="reasonChoicesForNegativeModal?.length > 0">
            <div class="font-weight-bold small">
                <span class="t-vertical-align-middle">{{ 'Signature_Reason' | translate }}</span>
            </div>
            <t-selector [(ngModel)]="reasonId" [choices]="reasonChoicesForNegativeModal">
            </t-selector>
        </div>

        <!-- Reason Details -->
        <div class="mt-3 mb-2">
            <div class="font-weight-bold small">
                <span class="t-vertical-align-middle">{{ 'Signature_ReasonDetails' | translate }}</span>
            </div>
            <t-text-editor [(ngModel)]="reasonDetails" [ngModelOptions]="{ updateOn: 'blur' }">
            </t-text-editor>
        </div>
    </div>

    <!-- footer -->
    <div class="modal-footer">
        <button class="btn btn-danger" (click)="modal.close(true)">
            <fa-icon icon="check"></fa-icon>
            &nbsp;{{ 'Confirm' | translate }}
        </button>
        <button class="btn btn-light text-primary t-white-button" (click)="modal.close(false)" ngbAutofocus>
            <fa-icon icon="times"></fa-icon>
            &nbsp;{{ 'Cancel' | translate }}
        </button>
    </div>
</ng-template>